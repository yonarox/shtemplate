#!/bin/sh 
# vim: set filetype=sh ts=2 sw=2 sts=2 et si ai: 

# tCommons.lib
# -
#
# Andres Aquino <aquino(at)hp.com>
# Hewlett-Packard Company | EBS
# 

# set environment
function LoadEnvironment
{

  # Predefined variables
  export U_LAND="`uname -s`"
  export U_HOST="`hostname | sed -e 's/\..*//g'`"
  export U_DATE="`date "+%Y%m%d"`"
  export U_HOUR="`date "+%H%M"`"
  export U_TIME="${U_DATE}${U_HOUR}"
  export U_NAME="Andres Aquino"
  export U_MAIL="aquino(at)hp.com"
  export U_WORK="Hewlett-Packard Company | EBS"

  # Terminal 
  export U_TERM="TERM"
  export EDITOR=vi
  export LANG="C"

  # Java Environment
  export JAVA_HOME=
  export JRE_HOME=
  export SHLIB_PATH=
  export U_PATH=${PATH}

  # System binaries
  [ -d /bin ] && PATH=/bin:${PATH}
  [ -d /sbin ] && PATH=/sbin:${PATH}
  [ -d /usr/bin ] && PATH=/usr/bin:${PATH}
  [ -d /usr/sbin ] && PATH=/usr/sbin:${PATH}
 
  # history file and manuals
  export HISTSIZE=1500
  export HISTCONTROL=ignoredups
  export MANPATH=${HOME}/manuals:${MANPATH}

  # Terminal settings by SO
  export HOSTNAME=`hostname`
  export TERM="xterm"
  export CLICOLOR="hxfxcxdxbxegedabagacad"
  export LSCOLORS="hxfxcxdxbxegedabagacad"

  # every os have a specific name for network interfaces 
  IFACE=
  [ "${U_LAND}" = "HP-UX" ]  && INTERFACE=lan
  [ "${U_LAND}" = "Linux" ]  && INTERFACE=eth
  [ "${U_LAND}" = "Darwin" ] && INTERFACE=en

  # .. and for any device
  for NDEV in 0 1 2 3 4
  do
    U_DEVICE="${INTERFACE}${NDEV}"
    U_ADDRESS=`ifconfig ${U_DEVICE} 2> /dev/null| awk '/inet [addr:]*/ {print $2}' | sed -e "s/.*://g"`
    [ -n "${U_ADDRESS}" ] && break
  done
  
  # sweet lo0, sweet localhost 
  [ -z "${U_ADDRESS}" ] && U_ADDRESS="127.0.0.1"

  # setting locale  
  SEQESCAPE="\033"
  FUNCTIONS="declare"
  [ "${U_LAND}" = "Linux" ] && SEQESCAPE="\e" 
  [ "${U_LAND}" != "HP-UX" ] && EDITOR=vim && LANG="en_US.UTF-8"
  [ "${U_LAND}" = "HP-UX" ] && FUNCTIONS="typeset"

  # common alias
  alias ls="ls -F"
  alias ll="ls -l"
  alias la="ll -a"
  alias lt="la -t"
  alias lr="lt -r"
  alias pw="pwd"
  alias defn="${FUNCTIONS}"
  alias java16="JavaEnvironment java16"
  alias java15="JavaEnvironment java15"
  alias java14="JavaEnvironment java14"

  # loading a terminal or only a process
  stty 2> /dev/null | grep -q 'baud' 
  if [ $? -eq 0 ]
  then
    stty erase "^?"
    stty intr "^C" 
    stty kill "^U" 
    stty stop "^S"
    stty susp "^Z"
    stty werase "^W"

    # command line _eye candy_
    U_TERM="CONSOLE"

    # command line _eye candy_
    CRESET="${SEQESCAPE}[0m"    # Text Reset
    TXTBLK="${SEQESCAPE}[0;30m" # Black - Regular
    TXTRED="${SEQESCAPE}[0;31m" # Red
    TXTGRN="${SEQESCAPE}[0;32m" # Green
    TXTYLW="${SEQESCAPE}[0;33m" # Yellow
    TXTBLU="${SEQESCAPE}[0;34m" # Blue
    TXTPUR="${SEQESCAPE}[0;35m" # Purple
    TXTCYN="${SEQESCAPE}[0;36m" # Cyan
    TXTWHT="${SEQESCAPE}[0;37m" # White
    BLDBLK="${SEQESCAPE}[1;30m" # Black - Bold
    BLDRED="${SEQESCAPE}[1;31m" # Red
    BLDGRN="${SEQESCAPE}[1;32m" # Green
    BLDYLW="${SEQESCAPE}[1;33m" # Yellow
    BLDBLU="${SEQESCAPE}[1;34m" # Blue
    BLDPUR="${SEQESCAPE}[1;35m" # Purple
    BLDCYN="${SEQESCAPE}[1;36m" # Cyan
    BLDWHT="${SEQESCAPE}[1;37m" # White
    UNKBLK="${SEQESCAPE}[4;30m" # Black - Underline
    UNDRED="${SEQESCAPE}[4;31m" # Red
    UNDGRN="${SEQESCAPE}[4;32m" # Green
    UNDYLW="${SEQESCAPE}[4;33m" # Yellow
    UNDBLU="${SEQESCAPE}[4;34m" # Blue
    UNDPUR="${SEQESCAPE}[4;35m" # Purple
    UNDCYN="${SEQESCAPE}[4;36m" # Cyan
    UNDWHT="${SEQESCAPE}[4;37m" # White
    BAKBLK="${SEQESCAPE}[40m"   # Black - Background
    BAKRED="${SEQESCAPE}[41m"   # Red
    BAKGRN="${SEQESCAPE}[42m"   # Green
    BAKYLW="${SEQESCAPE}[43m"   # Yellow
    BAKBLU="${SEQESCAPE}[44m"   # Blue
    BAKPUR="${SEQESCAPE}[45m"   # Purple
    BAKCYN="${SEQESCAPE}[46m"   # Cyan
    BAKWHT="${SEQESCAPE}[47m"   # White

  else
    # command line _eye candy_
    U_TERM="TERM"
    CRESET="${SEQESCAPE}[0m"    # Text Reset
    TXTBLK="${SEQESCAPE}[0;30m" # Black - Regular
    TXTRED="" # Red
    TXTGRN="" # Green
    TXTYLW="" # Yellow
    TXTBLU="" # Blue
    TXTPUR="" # Purple
    TXTCYN="" # Cyan
    TXTWHT="" # White

  fi

}

# Prints a message 
function PrintOut
{
  local message="${1}"

  case "${U_LAND}" in
    "HP-UX")
      echo "${message}"
    ;;
      
    "Linux")
      echo -e -n "${message} \n"
    ;;
    
    "Darwin")
      echo -e -n "${message} \n"
    ;;
      
    *)
      ${_echo} "${message} "
    ;;
  esac

}

function LoadProfile 
{
  local U_PROFILE=${1}
  if [ -s ${U_PROFILE} ]
  then
    . ${U_PROFILE} > /dev/null 2>&1
    U_PROFILE=`basename ${U_PROFILE}`
    LogInfo "Loading profile ${U_PROFILE}"
  fi

}

# Set a java environment
function JavaEnvironment
{
  local JAVA_ENV="${1}"

  # if not exist or is empty, exit 
  if [ ! -d "${HOME}/paths.d" -o -z "$(ls -A ${HOME}/paths.d)" ]
  then
    return 0
  fi

  # rebuild path and validate
  JAVA_PROF="${HOME}/paths.d/${JAVA_ENV}"
  
  # java path file? 
  grep -q java "${JAVA_PROF}" || return 0

  # reload paths to eliminate some java previous settings
  SetLocalPaths

  # Workaround
  # for OS-X systems, java commands are in Commands/ 
  BINARIES="bin"
  [ ${U_LAND} = "Darwin" ] && BINARIES="Commands"

  # rebuild path with java home
  for eachpath in $(cat ${JAVA_PROF})
  do
    # expand vars
    eachpath="$(eval echo ${eachpath})"
    if [ -d ${eachpath}/${BINARIES} ] 
    then
      # FIX:
      # must to use java bin of JRE_HOME firts 
      JAVA_HOME=${eachpath}
      JRE_HOME=${JAVA_HOME}/jre
      [ -d ${JAVA_HOME} ] && PATH=${JAVA_HOME}/${BINARIES}:${PATH}
      [ -d ${JRE_HOME}  ] && PATH=${JRE_HOME}/${BINARIES}:${PATH}
      LogInfo "Adding new path: ${eachpath}/${BINARIES}"

      export JVM_VERSION=`java -version 2>&1 | grep "version" | sed -e "s/\"//g;s/.*ion //g"`
      LogInfo "Setting JAVA_HOME to ${eachpath}, Ver. ${JVM_VERSION}"
      
      # workaround hp-ux & java16
      [ ${U_LAND} = "HP-UX" ] && [ ${JAVA_ENV} = "java16" ] && SHLIB_PATH=${JAVA_HOME}/jre/lib/PA_RISC2.0/jli
      return 0
    fi
  done

}

# Define a execution unix path reading each file in Paths.d
function SetLocalPaths 
{
  local LPATH=

  # System binaries
  [ -d /bin ] && LPATH=/bin:${LPATH}
  [ -d /sbin ] && LPATH=/sbin:${LPATH}
  [ -d /usr/bin ] && LPATH=/usr/bin:${LPATH}
  [ -d /usr/sbin ] && LPATH=/usr/sbin:${LPATH}
 
  # if not exist or is empty, exit 
  if [ ! -d "${HOME}/paths.d" -o -z "$(ls -A ${HOME}/paths.d)" ]
  then
    return 0
  fi

  # lock for any file with path as contents
  for pathfile in ${HOME}/paths.d/[0-9][0-9]*
  do
    # empty file
    [ ! -s ${pathfile} ] && continue
    
    # not include java paths
    grep -q java ${pathfile} && continue 

    # for each file, get paths and add to execution path
    bname=`basename ${pathfile}`
    isValid=false
    for eachpath in $(cat ${pathfile})
    do
      # get one line (path) and verify: is this a directory? 
      eachpath="$(eval echo ${eachpath} | sed -e 's/ *//g')"
      [ ! -d ${eachpath} ] && break 
      
      isValid=true
      LPATH=${LPATH}:${eachpath}
    done
    ${isValid} && LogInfo "Loading paths ${bname}"
  done

  # User binaries  
  [ -d ${HOME}/bin ] && LPATH="${HOME}/bin${LPATH}"

  LPATH="`echo ".:${LPATH}" | sed -e 's/::/:/g'`"
  PATH=${LPATH}:${U_PATH}

}

# Sets PS1 and PS2 using an _eye candy_ cmd line, if you're using Git it shows branch name
function SetCommandStyle 
{
  export _USERNAME=${U_NAME}
  export _USERMAIL=${U_MAIL}
  export _USERWORK=${U_WORK}

  [ "${U_TERM}" = "TERM" ] && return 0
  if [ "${U_LAND}" = "HP-UX" ]
  then
    export PS1="$(echo "\n${CRESET}[ ${TXTYLW}${U_ADDRESS}${CRESET} | ${U_HOST} ] \${PWD} \n${TXTWHT}${USER} ${CRESET}\$ ")"
  else
    if [ -s ~/git.profile ]
    then
      export PS1="\e]1;${U_ADDRESS}\a\e]2;${U_ADDRESS}:${U_HOST}\a\
                  \n\[${CRESET}\][ \[${TXTYLW}\]${U_ADDRESS}\[${CRESET}\] | ${U_HOST} ]\[${BLDGRN}\]\$(__git_ps1 '(%s)')\[${CRESET}\] \w \
                  \n\[${TXTWHT}\]${USER}\[${CRESET}\] \$ "
    else
      export PS1="\e]1;${U_ADDRESS}\a\e]2;${U_ADDRESS}:${U_HOST}\a\
                  \n\[${CRESET}\][ \[${TXTYLW}\]${U_ADDRESS}\[${CRESET}\] | ${U_HOST} ] \w \
                  \n\[${TXTWHT}\]${USER}\[${CRESET}\] \$ "
    fi
  fi
  export PS2=" ..> "
  unset USERNAME
}

function GetCurrTime
{
  U_DATE="`date "+%Y%m%d"`"
  U_HOUR="`date "+%H%M"`"
  U_TIME="${U_DATE}${U_HOUR}"
}

function DebugOn
{
  export U_DEBG=true
}

function DebugOff
{
  export U_DEBG=false
}

# logger
#LogInfo ()
#LogError ()
#LogAction ()
function LogInfo 
{
  local message="${1}"
  [ "${U_TERM}" = "TERM" ] && return 0
  ${U_DEBG} && PrintOut "${TXTBLU} >>  ${TXTWHT}${message}${CRESET}"

}

function LogError 
{
  local message="${1}"
  [ "${U_TERM}" = "TERM" ] && return 0
  ${U_DEBG} && PrintOut "${TXTRED} *  ${TXTWHT}${message}${CRESET}"
}

function LogMessage 
{
  local message="${1}"
  [ "${U_TERM}" = "TERM" ] && return 0
  PrintOut "${CRESET}${message}"

}

# Shows MD5 of this profile
function ShowVersion 
{
  U_FILEVERSION=`openssl dgst -md5 ~/unix.profile | rev | cut -c-4 | rev`
  PrintOut "Profile ver.${U_FILEVERSION} (${U_LAND}) \n${U_WORK} \n\nDeveloped by \nAndres Aquino <aquino(at)hp.com>"
}

# Shows Information about this system
function ShowInternals
{
  GetCurrTime
  PrintOut "-"
  PrintOut "${TXTRED}OpSystem  ${CRESET}: ${U_LAND}"
  PrintOut "${TXTRED}Hostname  ${CRESET}: ${U_HOST}"
  PrintOut "${TXTRED}CurrDate  ${CRESET}: ${U_DATE}"
  PrintOut "${TXTRED}CurrHour  ${CRESET}: ${U_HOUR}"
  PrintOut "${TXTRED}IpAddress ${CRESET}: ${U_ADDRESS}"
  PrintOut "${TXTRED}PathApps  ${CRESET}: ${PATH}"

}


function SetWorkProfile 
{
  LoadProfile ~/host-office.info

}

function SetHomeProfile 
{
  LoadProfile ~/host-home.info

}

